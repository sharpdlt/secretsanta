<template>
  <main class="l-main">
    <!--========== HOME ==========-->
    <section class="home" id="home">
      <div class="home__container bd-container bd-grid">
        <div class="home__img">
          <img src="/img/home.png" alt="" />
        </div>

        <div class="home__data">
          <h1 class="home__title">–°—Ç–∞–Ω—å –¢–∞–π–Ω—ã–º –°–∞–Ω—Ç–æ–π ‚Äì –ü–æ–¥–∞—Ä–∏ –£–ª—ã–±–∫—É!</h1>
          <p class="home__description">
            –û—Ä–≥–∞–Ω–∏–∑—É–π –Ω–µ–∑–∞–±—ã–≤–∞–µ–º—ã–π –æ–±–º–µ–Ω –ø–æ–¥–∞—Ä–∫–∞–º–∏ —Å –¥—Ä—É–∑—å—è–º–∏, –∫–æ–ª–ª–µ–≥–∞–º–∏ –∏–ª–∏
            —Å–µ–º—å–µ–π. –¢–∞–π–Ω—ã–π –°–∞–Ω—Ç–∞ ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± —Å–¥–µ–ª–∞—Ç—å –ø—Ä–∞–∑–¥–Ω–∏–∫ –≤–æ–ª—à–µ–±–Ω—ã–º
            –∏ –¥—É—à–µ–≤–Ω—ã–º.
          </p>
          <a href="#send" class="button">–ù–∞—á–∞—Ç—å</a>
        </div>
      </div>
    </section>

    <!--========== SHARE ==========-->
    <section class="share section bd-container" id="share">
      <div class="share__container bd-grid">
        <div class="share__data">
          <h2 class="section-title-center">–ü–æ–¥–µ–ª–∏—Å—å –≤–æ–ª—à–µ–±—Å—Ç–≤–æ–º –ø—Ä–∞–∑–¥–Ω–∏–∫–∞!</h2>
          <p class="share__description">
            "–ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–∑–µ–π, —Å–µ–º—å—é –∏–ª–∏ –∫–æ–ª–ª–µ–≥ —Å—Ç–∞—Ç—å —á–∞—Å—Ç—å—é –¢–∞–π–Ω–æ–≥–æ –°–∞–Ω—Ç—ã.
            –°–∫–æ–ø–∏—Ä—É–π —Å—Å—ã–ª–∫—É –∏ –ø–æ–¥–µ–ª–∏—Å—å —Ä–∞–¥–æ—Å—Ç—å—é –ø—Ä–∞–∑–¥–Ω–∏–∫–∞ ‚Äì —á–µ–º –±–æ–ª—å—à–µ
            —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, —Ç–µ–º –≤–µ—Å–µ–ª–µ–µ!"
          </p>
          <button
            type="button"
            class="button"
            @click="copyLink"
            :disabled="copyLinkSuccess"
          >
            {{
              copyLinkSuccess ? "–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!" : "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É!"
            }}
          </button>
        </div>

        <div class="share__img">
          <img src="/img/shared.png" alt="" />
        </div>
      </div>
    </section>

    <!--========== DECORATION ==========-->
    <section class="decoration section bd-container" id="decoration">
      <h2 class="section-title">–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –¢–∞–π–Ω—ã–π –°–∞–Ω—Ç–∞?</h2>
      <div class="decoration__container bd-grid">
        <div class="decoration__data">
          <img src="/img/decoration1.png" alt="" class="decoration__img" />
          <h3 class="decoration__title">–ó–∞–ø–æ–ª–Ω–∏ —Å–≤–æ–µ –∏–º—è –∏ –ø–æ—á—Ç—É</h3>
          <p>–£–∫–∞–∂–∏ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –æ–±–º–µ–Ω–µ –ø–æ–¥–∞—Ä–∫–∞–º–∏</p>
        </div>

        <div class="decoration__data">
          <img src="/img/decoration2.png" alt="" class="decoration__img" />
          <h3 class="decoration__title">–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–≤–æ–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö</h3>
          <p>–ù–∞–ø–∏—à–∏, —á—Ç–æ —Ç—ã —Ö–æ—Ç–µ–ª –±—ã –ø–æ–ª—É—á–∏—Ç—å, –∏ —á—Ç–æ —Ç–æ—á–Ω–æ –Ω–µ –Ω—É–∂–Ω–æ!</p>
        </div>

        <div class="decoration__data">
          <img src="/img/decoration3.png" alt="" class="decoration__img" />
          <h3 class="decoration__title">–ü–æ–¥–≥–æ—Ç–æ–≤—å—Å—è –∫ —Å—é—Ä–ø—Ä–∏–∑—É!</h3>
          <p>
            –û—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ä–º—É –∏ –∂–¥–∏, –∫–æ–≥–¥–∞ —Å–∏—Å—Ç–µ–º–∞ —Å–ª—É—á–∞–π–Ω–æ –≤—ã–±–µ—Ä–µ—Ç —Ç–≤–æ–µ–≥–æ –¢–∞–π–Ω–æ–≥–æ
            –°–∞–Ω—Ç—É. –ü–æ—Ä–∞ –≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –¥–∞—Ä–∏—Ç—å –∏ –ø–æ–ª—É—á–∞—Ç—å —Ä–∞–¥–æ—Å—Ç—å!
          </p>
        </div>
      </div>
    </section>

    <!--========== SEND GIFT ==========-->
    <section class="send section" id="send">
      <div class="send__container bd-container bd-grid">
        <div class="send__content">
          <h2 class="section-title-center send__title">
            –ó–∞–ø–æ–ª–Ω–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —É—á–∞—Å—Ç–∏—è
          </h2>
          <p class="send__description">
            –£–∫–∞–∂–∏ —Å–≤–æ–µ –∏–º—è, –ø–æ—á—Ç—É –∏ –æ—Å—Ç–∞–≤—å –ø–æ–∂–µ–ª–∞–Ω–∏—è, —á—Ç–æ–±—ã —Ç–≤–æ–π –¢–∞–π–Ω—ã–π –°–∞–Ω—Ç–∞
            –∑–Ω–∞–ª, —á—Ç–æ –ø–æ–¥–∞—Ä–∏—Ç—å. –í–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–º–æ–≥—É—Ç —Å–¥–µ–ª–∞—Ç—å –ø—Ä–∞–∑–¥–Ω–∏–∫
            –Ω–µ–∑–∞–±—ã–≤–∞–µ–º—ã–º!
          </p>
        </div>

        <div class="send__img">
          <img src="/img/send.png" alt="" />
        </div>

        <form action="" class="wish__form">
          <div class="wish__form-common">
            <div :class="['send__direction']">
              <input
                type="text"
                placeholder="–§–∞–º–∏–ª–∏—è –ò–º—è"
                class="send__input"
                v-model="fullname"
              />
            </div>
            <div :class="['send__direction', { shake: disabled }]">
              <input
                type="email"
                placeholder="–¢–≤–æ—è –ø–æ—á—Ç–∞"
                class="send__input"
                v-model="email"
              />
              <span v-if="validateEmail">‚úÖ</span>
              <span v-else-if="!validateEmail && email.length > 0">‚õî</span>

              <Transition>
                <span v-if="errorMessage" class="validation-error">{{
                  errorMessage
                }}</span>
              </Transition>
              <!-- <a href="#" class="button">Send</a> -->
            </div>
          </div>
          <div class="wish__table">
            <WishInput
              class="with__table-col"
              label="–ß–µ–≥–æ –±—ã —è —Ö–æ—Ç–µ–ª? ü§î"
              @update-tags="updateIWantTags"
            />
            <WishInput
              class="with__table-col"
              label="–ß–µ–≥–æ —è —Ç–æ—á–Ω–æ –Ω–µ —Ö–æ—á—É üëé"
              @update-tags="updateIDontWantTags"
            />
          </div>
          <div class="send__button">
            <button
              class="button"
              type="submit"
              @click.prevent="submitForm"
              :disabled="disableButton || disabled || successResponse"
            >
              <Transition name="slide-fade"> <span>üéÅ</span></Transition>
              –û—Ç–ø—Ä–∞–≤–∏—Ç—å!<Transition name="slide-fade">
                <span>üéÅ</span></Transition
              >
            </button>
            <span
              class="send__button-notify"
              v-if="validateWishLists && !successResponse"
              >–ù–µ –∑–∞–±—É–¥—å —É–∫–∞–∑–∞—Ç—å —Å–≤–æ–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è!</span
            >
            <Transition name="slide-fade">
              <span class="send__button-notify" v-if="successResponse"
                >–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –¢—ã —É—á–∞—Å—Ç–≤—É–µ—à—å –≤ –¢–∞–π–Ω–æ–º –°–∞–Ω—Ç–µ üéÖ</span
              >
            </Transition>
          </div>
        </form>
      </div>
    </section>
  </main>
</template>

<script setup>
const fullname = ref("");
const email = ref("");
const iWantTags = ref([]);
const iDontWantTags = ref([]);
const config = useRuntimeConfig();

useHead({
  title: "–£—á–∞—Å—Ç–≤—É–π –≤ –¢–∞–π–Ω–æ–º –°–∞–Ω—Ç–µ!",
});

//for inputs
const disabled = ref(false);
const errorMessage = ref("");
const copyLinkSuccess = ref(false);

const successResponse = ref(false);

const copyLink = async () => {
  try {
    const currentUrl = window.location.href; // –¢–µ–∫—É—â–∏–π URL
    await navigator.clipboard.writeText(currentUrl);
    copyLinkSuccess.value = true;

    setTimeout(() => {
      copyLinkSuccess.value = false;
    }, 2000);
  } catch (err) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å—Å—ã–ª–∫–∏:", err);
  }
};

const updateIWantTags = (tags) => {
  iWantTags.value = tags;
};
const updateIDontWantTags = (tags) => {
  iDontWantTags.value = tags;
};

const postData = computed(() => {
  return {
    full_name: fullname.value,
    email: email.value,
    wishlist: iWantTags.value,
    no_wishlist: iDontWantTags.value,
  };
});

const validateEmail = computed(() => {
  const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailPattern.test(email.value) && !disabled.value;
});
const validateWishLists = computed(() => {
  return (
    iDontWantTags.value.length === 0 &&
    iWantTags.value.length === 0 &&
    fullname.value.length > 0 &&
    validateEmail.value
  );
});
const disableButton = computed(() => {
  return !validateEmail.value || fullname.value.length === 0;
});

function warnDisabled(errorStatus) {
  disabled.value = true;

  if (errorStatus === 400) {
    errorMessage.value = "–ü–æ—á—Ç–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏";
  }
  setTimeout(() => {
    disabled.value = false;
  }, 2000);

  setTimeout(() => {
    errorMessage.value = "";
  }, 4000);
}

function warnSuccess() {
  successResponse.value = true;

  setTimeout(() => {
    successResponse.value = false;
  }, 4000);
}
const submitForm = async () => {
  try {
    const data = await $fetch("/api/users", {
      method: "POST",
      baseURL: config.public.apiBase,
      body: postData.value,
    });

    warnSuccess();
  } catch (e) {
    warnDisabled(e.status);
  }
};
</script>
